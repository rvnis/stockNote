# Quant-JP - アイデアメモ

## このドキュメントの位置づけ

このドキュメントは壁打ち・ブレストの成果物で、正式な仕様書ではありません。

## プロダクトビジョン

J-Quantsデータを基盤とした日本株マーケットニュートラル戦略の構築・検証プラットフォーム。データ取得から特徴量作成、バックテスト、ポートフォリオ構築まで一気通貫で行える環境を目指す。

**一言で言うと**: 日本株クオンツ運用のためのオールインワン分析基盤

---

## 解決したい課題

### 今困っていること

1. **データ基盤の構築が面倒**
   - J-Quantsからデータを取得しても、そのままでは使いにくい
   - 株式分割・併合の調整、銘柄コード変更の追跡が手作業
   - 毎回同じ前処理を書いている

2. **特徴量管理がバラバラ**
   - 作成した特徴量がスクリプトごとに散らばっている
   - 「あの特徴量どこで定義したっけ？」となる
   - バックテストと本番で違う特徴量を使ってしまうリスク

3. **戦略の検証に時間がかかる**
   - 新しいアイデアを試すたびにボイラープレートコードを書く
   - バックテスト環境と分析環境が分離している
   - 複数戦略の比較・アンサンブルが難しい

4. **リスク管理が後回しになりがち**
   - セクターエクスポージャーの確認が面倒
   - ドローダウンやVaRを都度計算している
   - ポートフォリオ全体のリスク把握が不十分

---

## ターゲットユーザー

### メインユーザー: 自分（+チームメンバー）

- **運用スタイル**: マーケットニュートラル（ロング/ショート各100-200銘柄）
- **リバランス頻度**: 日次
- **セクター方針**: 東証33業種ベースでセクター内ニュートラルを目指す
- **技術レベル**: Pythonで戦略を書ける
- **環境**: ローカルMac（メモリ16GB）、Docker運用

### チーム利用について

- 優先度は低い
- 画面共有で議論する程度の利用を想定
- 各自がログインして使う機能は当面不要

---

## 主要機能の候補

### P0 (MVP - 1つの戦略でバックテストできるところまで)

#### 1. データパイプライン
```
- J-Quants APIからの日次データ自動取得
- 株価データ（OHLCV）
- 財務データ
- 銘柄マスタ（市場区分、業種など）
- 株式分割・併合の自動調整
- 銘柄コード変更の追跡
```

#### 2. 銘柄ユニバース管理
```
- 時価総額フィルタ（例: 100億円以上）
- 売買代金フィルタ（例: 日次1億円以上）
- 市場区分フィルタ
- ユニバースの履歴管理（サバイバーシップバイアス対策）
```

#### 3. 特徴量フレームワーク
```python
# こんな感じで特徴量を定義できるイメージ
@feature(name="momentum_20d", category="technical")
def momentum_20d(prices: pd.DataFrame) -> pd.Series:
    return prices['close'].pct_change(20)
```
```
- 特徴量の定義・登録
- Feature Store（計算済み特徴量の保存・再利用）
- メタデータ管理（定義、作成日時、依存関係）
```

#### 4. 戦略プラグインシステム
```python
# こんな感じで戦略を定義できるイメージ
class MomentumStrategy(BaseStrategy):
    def generate_signals(self, features: FeatureSet) -> pd.DataFrame:
        # ロング/ショートのシグナルを返す
        return signals
```
```
- 戦略の基底クラス提供
- Pythonファイルをプラグインとして読み込み
- 戦略のパラメータ管理
```

#### 5. バックテストエンジン
```
- 単一戦略のバックテスト
- 日次リバランス対応
- 基本的なパフォーマンス指標（リターン、シャープレシオ、ドローダウン）
- 取引コスト（手数料）の考慮
- ※貸株料は考慮しない
```

### P1 (重要だけど後回しでもいい)

#### 6. スクリーニング機能
```
- ファンダメンタル条件（PER、PBR、ROE、配当利回り等）
- テクニカル条件（移動平均、RSI、MACD等）
- カスタム条件（N日連続陽線など）
- 条件の保存・再利用
```

#### 7. ポートフォリオ構築
```
- ロング/ショートの銘柄選定
- セクターニュートラル制約
- ウェイト最適化
- リバランス計画の生成
```

#### 8. リスク管理
```
- VaR計算
- 最大ドローダウン
- セクターエクスポージャー分析
- 銘柄集中度チェック
- 相関分析
```

#### 9. Web UI（基本）
```
- ダッシュボード
- バックテスト結果の可視化
- 基本的なチャート表示
```

### P2 (あったら嬉しい)

#### 10. 高度な戦略機能
```
- 複数戦略のアンサンブル
- 機械学習モデルの統合
- ウォークフォワード分析
```

#### 11. Web UI（高度）
```
- インタラクティブなチャート
- 銘柄比較機能
- スクリーニング画面
- ポートフォリオ管理画面
```

#### 12. 外部データ連携（将来）
```
- 海外株価データ
- 商品（コモディティ）データ
- 決算情報
- SNS（X等）のセンチメント
```

---

## 技術構成

### 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│  Web UI (React + TypeScript)                             │
│  - ダッシュボード                                         │
│  - バックテスト結果表示                                   │
│  - チャート (TradingView Lightweight Charts)             │
└─────────────────────────────────────────────────────────┘
                          ↓ REST API
┌─────────────────────────────────────────────────────────┐
│  Backend (Python + FastAPI)                              │
│  - データ取得・加工                                       │
│  - 特徴量計算エンジン                                     │
│  - 戦略プラグインシステム                                 │
│  - バックテストエンジン                                   │
│  - リスク計算                                            │
└─────────────────────────────────────────────────────────┘
          ↓                    ↓                    ↓
┌─────────────┐    ┌─────────────────┐    ┌──────────────┐
│ PostgreSQL  │    │ Feature Store   │    │ Strategy     │
│ - 株価      │    │ (Parquet)       │    │ Plugins      │
│ - 財務      │    │ - 特徴量        │    │ (Python)     │
│ - 銘柄マスタ │    │ - メタデータ    │    │              │
└─────────────┘    └─────────────────┘    └──────────────┘
          ↑
┌─────────────────────────────────────────────────────────┐
│  Data Pipeline (日次バッチ)                              │
│  - J-Quants API → データ取得                             │
│  - 株式分割・併合調整                                     │
│  - 特徴量自動更新                                        │
└─────────────────────────────────────────────────────────┘
```

### 技術選定

| レイヤー | 技術 | 選定理由 |
|---------|------|----------|
| フロントエンド | React + TypeScript | エコシステムが充実、型安全 |
| チャート | TradingView Lightweight Charts | 軽量、金融特化、無料 |
| バックエンドAPI | FastAPI (Python) | 高速、型ヒント、自動ドキュメント |
| データ処理 | pandas, polars | 定番、高速 |
| 機械学習 | scikit-learn, LightGBM | 軽量で十分な機能 |
| DB | PostgreSQL | 信頼性、JSONサポート、拡張性 |
| Feature Store | Parquet + メタデータJSON | シンプル、高速、ファイルベース |
| コンテナ | Docker Compose | ローカル開発に最適 |

### DB選定の補足

PostgreSQLを選んだ理由:
- SQLiteより並行アクセスに強い（将来のチーム利用に備えて）
- DuckDBは分析特化だがWebアプリのバックエンドとしては不向き
- 時系列データもインデックスで十分高速
- Dockerで簡単にセットアップ可能

---

## 銘柄ユニバース定義

### 基本条件

```yaml
universe:
  market_cap_min: 10_000_000_000  # 時価総額100億円以上
  daily_turnover_min: 100_000_000  # 日次売買代金1億円以上
  exclude:
    - REIT
    - ETF
    - 新規上場1年未満（オプション）
```

### セクター分類

- 東証33業種をベースに使用
- セクター内でロング/ショートのウェイトをバランス

---

## 非機能要件

### パフォーマンス
- 日次データ更新: 10分以内
- 特徴量計算（全銘柄）: 5分以内
- バックテスト（1年、1戦略）: 1分以内
- UI応答: 1秒以内

### 運用環境
- ローカルMac（メモリ16GB、ストレージ30GB利用可能）
- Docker Compose で全コンポーネント起動
- 常時起動でデータ更新（cronまたはスケジューラ）

### リソース見積もり
- 株価データ（5年）: 約5GB
- 財務データ: 約2GB
- Feature Store: 約5-10GB
- DB + その他: 約5GB
- 合計: 約20GB（30GBに収まる）

### 拡張性
- 新しい特徴量を簡単に追加可能
- 新しい戦略をPythonファイルで追加可能
- 外部データソースの追加に対応できる設計

---

## 開発フェーズ

### Phase 1: データ基盤（MVP基盤）
```
- Dockerセットアップ
- PostgreSQLスキーマ設計
- J-Quantsデータ取得パイプライン
- 銘柄マスタ管理（分割調整含む）
- 銘柄ユニバース管理
```

### Phase 2: 分析基盤（MVP）
```
- 特徴量フレームワーク
- Feature Store実装
- 基本的な特徴量（テクニカル、ファンダメンタル）
```

### Phase 3: 戦略・バックテスト（MVP完成）
```
- 戦略プラグインシステム
- バックテストエンジン
- サンプル戦略の実装
- パフォーマンス指標計算
```

### Phase 4: リスク管理・ポートフォリオ
```
- リスク指標計算
- セクターニュートラル制約
- ポートフォリオ最適化
```

### Phase 5: Web UI
```
- バックエンドAPI整備
- フロントエンド構築
- ダッシュボード
- チャート表示
```

### Phase 6: 高度な機能
```
- スクリーニング機能
- 戦略アンサンブル
- 機械学習統合
```

---

## 成功指標

### MVP完成の定義
- [ ] J-Quantsからデータを自動取得できる
- [ ] 銘柄ユニバースを定義できる
- [ ] 特徴量を定義・保存・再利用できる
- [ ] Pythonで書いた戦略でバックテストできる
- [ ] シャープレシオ、ドローダウン等の指標が見れる

### プロダクト成熟の指標
- 10個以上の特徴量が登録されている
- 3つ以上の戦略を比較検証できている
- 日次で安定してデータ更新が回っている
- 実際の投資判断に活用できている

---

## 今後の検討事項

### まだ決めてないこと

1. **バックテストの詳細仕様**
   - 約定価格の仮定（始値、終値、VWAP）
   - スリッページのモデル化
   - 売買制限（ストップ高/安）の扱い

2. **特徴量の標準化**
   - クロスセクショナルな標準化？
   - 時系列での標準化？

3. **ポートフォリオ最適化の手法**
   - 均等ウェイト
   - リスクパリティ
   - 最適化ベース（最小分散など）

### 技術的に注意が必要なこと

1. **メモリ制約（16GB）**
   - 全銘柄×長期間の処理は分割が必要
   - 機械学習の学習時はバッチ処理を検討

2. **J-Quants APIの制限**
   - スタンダードプランの制限を確認
   - レートリミットへの対応

3. **株式分割の遡及修正**
   - 分割発表後に過去データを修正する必要
   - 調整係数の管理方法

---

## 次のステップ

1. **このドキュメントのレビュー**
   - 抜けている視点はないか？
   - 優先順位は妥当か？

2. **Claude Codeでプロジェクト初期化**
   - ディレクトリ構成の決定
   - Docker Compose設定
   - 基本的なスキーマ設計

3. **Phase 1の実装開始**
   - J-Quants API接続
   - データ取得の実装
